# ğŸš€ FASE 7: COMPARTIR Y EXPORTAR - QUICK START

**Estado**: ğŸ”œ PrÃ³xima a implementar
**EstimaciÃ³n**: 2-3 dÃ­as
**Prioridad**: ALTA

---

## ğŸ“‹ Tareas de FASE 7

### 1. GeneraciÃ³n de ImÃ¡genes âœï¸
**Objetivo**: Crear imÃ¡genes compartibles de registros y mantenimientos

**Archivos a Crear**:
```
app/src/main/java/com/maintenance/app/
â”œâ”€â”€ domain/usecase/
â”‚   â”œâ”€â”€ GenerateRecordImageUseCase.kt
â”‚   â””â”€â”€ GenerateMaintenanceImageUseCase.kt
â”œâ”€â”€ presentation/utils/
â”‚   â”œâ”€â”€ ImageGenerationUtils.kt
â”‚   â””â”€â”€ CanvasDrawingUtils.kt
â””â”€â”€ presentation/ui/components/
    â”œâ”€â”€ ImagePreviewCard.kt
    â””â”€â”€ ShareOptionsDialog.kt
```

**Componentes Necesarios**:
- Canvas drawing para layouts
- Image compression
- Template designs
- Logo/watermark integration

**Dependencias**:
```gradle
// Canvas and graphics
implementation("androidx.graphics:graphics-core:1.0.0-alpha03")

// Image compression
implementation("id.zelory:compressor:3.0.1")

// Bitmap utilities
// Already available in framework
```

### 2. Compartir en WhatsApp ğŸ“±
**Objetivo**: Integrar sharing a WhatsApp con imÃ¡genes

**Archivos a Crear**:
```
app/src/main/java/com/maintenance/app/
â”œâ”€â”€ domain/usecase/
â”‚   â”œâ”€â”€ ShareToWhatsAppUseCase.kt
â”‚   â”œâ”€â”€ ShareToOtherAppsUseCase.kt
â”‚   â””â”€â”€ CopyToClipboardUseCase.kt
â”œâ”€â”€ presentation/viewmodel/
â”‚   â””â”€â”€ ShareViewModel.kt
â””â”€â”€ presentation/ui/screens/
    â””â”€â”€ ShareScreen.kt
```

**Funcionalidad**:
- Generar imagen + texto
- Detectar WhatsApp instalado
- Fallback para otras apps
- Copy to clipboard option
- Share history

### 3. Permisos y Seguridad ğŸ”
**Objetivo**: Manejar permisos correctamente

**Archivos a Crear**:
```
app/src/main/java/com/maintenance/app/
â””â”€â”€ presentation/utils/
    â”œâ”€â”€ PermissionUtils.kt
    â”œâ”€â”€ PermissionChecker.kt
    â””â”€â”€ PermissionHandler.kt
```

**Permisos Necesarios** (AndroidManifest.xml):
```xml
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.CAMERA" />
```

**Runtime Permissions**:
- READ_EXTERNAL_STORAGE (API < 33)
- WRITE_EXTERNAL_STORAGE (API < 33)
- POST_NOTIFICATIONS (API 33+)

---

## ğŸ¨ DiseÃ±o de Templates

### Template 1: Record Image
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ”§ MAINTENANCE RECORD             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Device: [device_name]              â”‚
â”‚  Category: [category]               â”‚
â”‚  Type: [maintenance_type]           â”‚
â”‚                                     â”‚
â”‚  Description:                       â”‚
â”‚  [full_description]                 â”‚
â”‚                                     â”‚
â”‚  Cost: $[cost]                      â”‚
â”‚  Date: [date_formatted]             â”‚
â”‚  Next: [next_date]                  â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“… [current_date]     [LOGO]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Template 2: Maintenance Summary
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“‹ MAINTENANCE SUMMARY            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Device: [device_name]              â”‚
â”‚  Total Maintenance: [count]         â”‚
â”‚  Total Cost: $[total]               â”‚
â”‚                                     â”‚
â”‚  Recent Maintenance:                â”‚
â”‚  â€¢ [maintenance_1] - $[cost_1]      â”‚
â”‚  â€¢ [maintenance_2] - $[cost_2]      â”‚
â”‚  â€¢ [maintenance_3] - $[cost_3]      â”‚
â”‚                                     â”‚
â”‚  Status: âœ… [status]                â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Generated by MaintenanceApp        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» ImplementaciÃ³n Recomendada

### Paso 1: Crear ShareViewModel
```kotlin
@HiltViewModel
class ShareViewModel @Inject constructor(
    private val generateRecordImageUseCase: GenerateRecordImageUseCase,
    private val shareToWhatsAppUseCase: ShareToWhatsAppUseCase,
    private val checkPermissionUseCase: CheckPermissionUseCase
) : ViewModel() {
    // State management
    // Funciones para generar imÃ¡genes
    // Funciones para compartir
}
```

### Paso 2: Crear Utility Functions
```kotlin
object ImageGenerationUtils {
    fun generateRecordImage(record: Record): Bitmap { }
    fun generateMaintenanceImage(maintenance: Maintenance): Bitmap { }
    fun generateSummaryImage(device: Device): Bitmap { }
    fun compressImage(bitmap: Bitmap): File { }
}

object ShareUtils {
    fun shareToWhatsApp(context: Context, text: String, imageUri: Uri) { }
    fun shareToOtherApps(context: Context, text: String, imageUri: Uri) { }
    fun copyToClipboard(context: Context, text: String) { }
}
```

### Paso 3: Crear Share Screen
```kotlin
@Composable
fun ShareScreen(
    viewModel: ShareViewModel = hiltViewModel(),
    recordId: Long,
    navController: NavController
) {
    // State
    val uiState by viewModel.uiState.collectAsState()
    
    // UI
    Column {
        // Image preview
        // Share buttons (WhatsApp, Others, Copy)
        // Template selector
        // Text editor
    }
}
```

### Paso 4: Agregar NavegaciÃ³n
```kotlin
// En MainNavHost.kt
composable(
    route = "share/{recordId}",
    arguments = listOf(navArgument("recordId") { type = NavType.LongType })
) { backStackEntry ->
    val recordId = backStackEntry.arguments?.getLong("recordId") ?: return@composable
    ShareScreen(recordId = recordId, navController = navController)
}

// En Record detail screen
Button(onClick = {
    navController.navigate("share/$recordId")
}) {
    Text("Share")
}
```

---

## ğŸ§ª Testing Considerations

### Unit Tests
- Test ImageGenerationUtils functions
- Test permission checking
- Test share intent creation

### Integration Tests
- Test full share flow
- Test with mock images
- Test file creation/deletion

### UI Tests
- Test ShareScreen UI
- Test button interactions
- Test template selection

---

## ğŸ“¦ Resource Requirements

### Assets Needed
- App logo/watermark (PNG, transparent)
- Share icons for buttons
- Template backgrounds (optional)

### Permissions to Request
```
READ_EXTERNAL_STORAGE
WRITE_EXTERNAL_STORAGE
POST_NOTIFICATIONS
```

### Storage
- Temporary directory for image generation
- Clear strategy for old files

---

## ğŸ”— Integration Points

### From Existing Code
- `Record` model from Phase 4
- `Maintenance` model from Phase 4
- `Device` model
- `MaintenanceRepository` for data
- Navigation from Phase 3

### To Next Phases
- Phase 8 can use generated images for backup
- Phase 9 needs tests for share functionality
- Phase 10 needs to include share feature in release

---

## ğŸ“± WhatsApp Integration Details

### Detecting WhatsApp
```kotlin
fun isWhatsAppInstalled(context: Context): Boolean {
    return try {
        context.packageManager.getPackageInfo("com.whatsapp", 0)
        true
    } catch (e: Exception) {
        false
    }
}
```

### Sharing to WhatsApp
```kotlin
fun shareToWhatsApp(context: Context, text: String, imageUri: Uri) {
    val intent = Intent().apply {
        action = Intent.ACTION_SEND
        putExtra(Intent.EXTRA_TEXT, text)
        putExtra(Intent.EXTRA_STREAM, imageUri)
        type = "image/*"
        setPackage("com.whatsapp")
    }
    context.startActivity(intent)
}
```

### Fallback for Others
```kotlin
fun shareToOtherApps(context: Context, text: String, imageUri: Uri) {
    val intent = Intent().apply {
        action = Intent.ACTION_SEND
        putExtra(Intent.EXTRA_TEXT, text)
        putExtra(Intent.EXTRA_STREAM, imageUri)
        type = "image/*"
    }
    context.startActivity(Intent.createChooser(intent, "Share via"))
}
```

---

## ğŸš¨ Common Pitfalls to Avoid

1. âŒ Not handling FILE permissions on API < 30
2. âŒ Not compressing images before sharing
3. âŒ Not clearing temporary files
4. âŒ Not handling case when WhatsApp not installed
5. âŒ Not requesting permissions before file operations
6. âŒ Creating Bitmaps in main thread (use Coroutines)

---

## âœ… Success Criteria for FASE 7

- [ ] Can generate images for records
- [ ] Can generate images for maintenance entries
- [ ] Can share to WhatsApp (if installed)
- [ ] Can share to other apps
- [ ] Copy to clipboard works
- [ ] All permissions handled properly
- [ ] Images are compressed and optimized
- [ ] No memory leaks with Bitmap handling
- [ ] Temporary files cleaned up
- [ ] Full test coverage
- [ ] APK builds successfully

---

## ğŸš€ Next Commands (when ready)

```bash
# When starting Phase 7 implementation
git checkout -b feature/phase-7-sharing

# Create feature branch structure
# Implement GenerateImageUseCase
# Implement ShareViewModel
# Create ShareScreen
# Test share functionality
# Commit and create PR
```

**Ready to start FASE 7? Ask me: "Sigue con: Compartir y Exportar (FASE 7)"**
